# 営業日報システム テスト仕様書

## 1. テスト概要

### 1.1 テスト対象

| 対象 | 説明 |
|------|------|
| システム名 | 営業日報システム |
| テスト範囲 | 全機能 |

### 1.2 テスト種別

| 種別 | 説明 | ツール |
|------|------|--------|
| 単体テスト | 関数・コンポーネント単位 | Jest / Vitest |
| 結合テスト | API・DB連携 | Jest / Supertest |
| E2Eテスト | 画面操作シナリオ | Playwright |

### 1.3 テスト環境

| 環境 | 説明 |
|------|------|
| テストDB | MongoDB (テスト用インスタンス) |
| テストデータ | シードデータ使用 |

---

## 2. 単体テスト仕様

### 2.1 認証機能

#### UT-AUTH-001: パスワードハッシュ化

| 項目 | 内容 |
|------|------|
| テストID | UT-AUTH-001 |
| テスト対象 | hashPassword() |
| 前提条件 | - |
| 入力 | 平文パスワード "password123" |
| 期待結果 | ハッシュ値が返される（bcrypt形式） |
| 確認項目 | 同じ入力でも異なるハッシュが生成される |

#### UT-AUTH-002: パスワード検証

| 項目 | 内容 |
|------|------|
| テストID | UT-AUTH-002 |
| テスト対象 | verifyPassword() |
| 前提条件 | ハッシュ化されたパスワードが存在 |
| 入力 | 平文パスワード、ハッシュ値 |
| 期待結果 | 一致時: true、不一致時: false |

#### UT-AUTH-003: JWTトークン生成

| 項目 | 内容 |
|------|------|
| テストID | UT-AUTH-003 |
| テスト対象 | generateToken() |
| 前提条件 | - |
| 入力 | ユーザーID、役職 |
| 期待結果 | 有効なJWTトークンが生成される |
| 確認項目 | トークンにuser_id, roleが含まれる |

#### UT-AUTH-004: JWTトークン検証

| 項目 | 内容 |
|------|------|
| テストID | UT-AUTH-004 |
| テスト対象 | verifyToken() |
| テストケース | 有効なトークン → ペイロード返却 |
| | 期限切れトークン → エラー |
| | 不正なトークン → エラー |

### 2.2 バリデーション

#### UT-VAL-001: メールアドレス形式検証

| 項目 | 内容 |
|------|------|
| テストID | UT-VAL-001 |
| テスト対象 | validateEmail() |
| テストケース | "test@example.com" → true |
| | "invalid-email" → false |
| | "" → false |

#### UT-VAL-002: 日報日付検証

| 項目 | 内容 |
|------|------|
| テストID | UT-VAL-002 |
| テスト対象 | validateReportDate() |
| テストケース | 過去日 → true |
| | 今日 → true |
| | 未来日 → false |

#### UT-VAL-003: 訪問内容文字数検証

| 項目 | 内容 |
|------|------|
| テストID | UT-VAL-003 |
| テスト対象 | validateVisitContent() |
| テストケース | 1〜1000文字 → true |
| | 空文字 → false |
| | 1001文字以上 → false |

### 2.3 ユーティリティ

#### UT-UTIL-001: 日付フォーマット

| 項目 | 内容 |
|------|------|
| テストID | UT-UTIL-001 |
| テスト対象 | formatDate() |
| 入力 | Date オブジェクト |
| 期待結果 | "2024年12月15日（日）" 形式 |

#### UT-UTIL-002: ページネーション計算

| 項目 | 内容 |
|------|------|
| テストID | UT-UTIL-002 |
| テスト対象 | calcPagination() |
| テストケース | total=100, page=1, limit=20 → totalPages=5 |
| | total=0, page=1, limit=20 → totalPages=0 |

---

## 3. 結合テスト仕様（API）

### 3.1 認証API

#### IT-AUTH-001: ログイン成功

| 項目 | 内容 |
|------|------|
| テストID | IT-AUTH-001 |
| エンドポイント | POST /api/auth/login |
| 前提条件 | ユーザー "yamada@example.com" が登録済み |
| リクエスト | `{"email": "yamada@example.com", "password": "password123"}` |
| 期待結果 | ステータス: 200 |
| | レスポンスにtoken, userが含まれる |

#### IT-AUTH-002: ログイン失敗（パスワード不一致）

| 項目 | 内容 |
|------|------|
| テストID | IT-AUTH-002 |
| エンドポイント | POST /api/auth/login |
| リクエスト | `{"email": "yamada@example.com", "password": "wrongpass"}` |
| 期待結果 | ステータス: 401 |
| | エラーコード: UNAUTHORIZED |

#### IT-AUTH-003: ログイン失敗（ユーザー未登録）

| 項目 | 内容 |
|------|------|
| テストID | IT-AUTH-003 |
| エンドポイント | POST /api/auth/login |
| リクエスト | `{"email": "unknown@example.com", "password": "password123"}` |
| 期待結果 | ステータス: 401 |

### 3.2 日報API

#### IT-REPORT-001: 日報一覧取得

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-001 |
| エンドポイント | GET /api/reports |
| 前提条件 | 認証済み、日報データが存在 |
| リクエスト | `?page=1&limit=10` |
| 期待結果 | ステータス: 200 |
| | reports配列が返される |
| | paginationが含まれる |

#### IT-REPORT-002: 日報一覧（日付フィルタ）

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-002 |
| エンドポイント | GET /api/reports |
| リクエスト | `?date_from=2024-12-01&date_to=2024-12-15` |
| 期待結果 | 指定期間の日報のみ返される |

#### IT-REPORT-003: 日報詳細取得

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-003 |
| エンドポイント | GET /api/reports/:id |
| 前提条件 | 日報ID "report_001" が存在 |
| 期待結果 | ステータス: 200 |
| | visits, comments が含まれる |

#### IT-REPORT-004: 日報詳細（存在しない）

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-004 |
| エンドポイント | GET /api/reports/invalid_id |
| 期待結果 | ステータス: 404 |
| | エラーコード: NOT_FOUND |

#### IT-REPORT-005: 日報作成成功

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-005 |
| エンドポイント | POST /api/reports |
| 前提条件 | 営業ユーザーで認証済み |
| リクエスト | 日報データ（訪問記録含む） |
| 期待結果 | ステータス: 201 |
| | 日報IDが返される |
| | DBに日報・訪問記録が保存される |

#### IT-REPORT-006: 日報作成失敗（未来日）

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-006 |
| エンドポイント | POST /api/reports |
| リクエスト | `{"report_date": "2099-12-31", ...}` |
| 期待結果 | ステータス: 400 |
| | エラーコード: VALIDATION_ERROR |

#### IT-REPORT-007: 日報作成失敗（同一日重複）

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-007 |
| エンドポイント | POST /api/reports |
| 前提条件 | 同日の日報が既に存在 |
| 期待結果 | ステータス: 400 |
| | エラーコード: DUPLICATE_ENTRY |

#### IT-REPORT-008: 日報更新成功

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-008 |
| エンドポイント | PUT /api/reports/:id |
| 前提条件 | 本人の日報が存在 |
| 期待結果 | ステータス: 200 |
| | DBが更新される |

#### IT-REPORT-009: 日報更新失敗（他人の日報）

| 項目 | 内容 |
|------|------|
| テストID | IT-REPORT-009 |
| エンドポイント | PUT /api/reports/:id |
| 前提条件 | 他ユーザーの日報 |
| 期待結果 | ステータス: 403 |
| | エラーコード: FORBIDDEN |

### 3.3 コメントAPI

#### IT-COMMENT-001: コメント投稿成功

| 項目 | 内容 |
|------|------|
| テストID | IT-COMMENT-001 |
| エンドポイント | POST /api/reports/:id/comments |
| 前提条件 | 上長ユーザーで認証済み |
| リクエスト | `{"target_type": "PROBLEM", "content": "確認しました"}` |
| 期待結果 | ステータス: 201 |
| | コメントが保存される |

#### IT-COMMENT-002: コメント投稿失敗（営業ユーザー）

| 項目 | 内容 |
|------|------|
| テストID | IT-COMMENT-002 |
| エンドポイント | POST /api/reports/:id/comments |
| 前提条件 | 営業ユーザーで認証 |
| 期待結果 | ステータス: 403 |

### 3.4 顧客API

#### IT-CUSTOMER-001: 顧客一覧取得

| 項目 | 内容 |
|------|------|
| テストID | IT-CUSTOMER-001 |
| エンドポイント | GET /api/customers |
| 期待結果 | ステータス: 200 |
| | customers配列が返される |

#### IT-CUSTOMER-002: 顧客検索

| 項目 | 内容 |
|------|------|
| テストID | IT-CUSTOMER-002 |
| エンドポイント | GET /api/customers?keyword=ABC |
| 期待結果 | "ABC"を含む顧客のみ返される |

#### IT-CUSTOMER-003: 顧客登録成功

| 項目 | 内容 |
|------|------|
| テストID | IT-CUSTOMER-003 |
| エンドポイント | POST /api/customers |
| 前提条件 | 上長ユーザーで認証 |
| 期待結果 | ステータス: 201 |

#### IT-CUSTOMER-004: 顧客登録失敗（権限なし）

| 項目 | 内容 |
|------|------|
| テストID | IT-CUSTOMER-004 |
| エンドポイント | POST /api/customers |
| 前提条件 | 営業ユーザーで認証 |
| 期待結果 | ステータス: 403 |

### 3.5 ユーザーAPI

#### IT-USER-001: ユーザー一覧取得（上長）

| 項目 | 内容 |
|------|------|
| テストID | IT-USER-001 |
| エンドポイント | GET /api/users |
| 前提条件 | 上長ユーザーで認証 |
| 期待結果 | ステータス: 200 |

#### IT-USER-002: ユーザー一覧取得失敗（営業）

| 項目 | 内容 |
|------|------|
| テストID | IT-USER-002 |
| エンドポイント | GET /api/users |
| 前提条件 | 営業ユーザーで認証 |
| 期待結果 | ステータス: 403 |

#### IT-USER-003: パスワード変更成功

| 項目 | 内容 |
|------|------|
| テストID | IT-USER-003 |
| エンドポイント | PUT /api/users/:id/password |
| リクエスト | `{"current_password": "old", "new_password": "new"}` |
| 期待結果 | ステータス: 200 |
| | 新パスワードでログイン可能 |

---

## 4. E2Eテスト仕様

### 4.1 ログインシナリオ

#### E2E-LOGIN-001: ログイン成功

| 項目 | 内容 |
|------|------|
| テストID | E2E-LOGIN-001 |
| シナリオ | 正常ログイン |
| 手順 | 1. /login にアクセス |
| | 2. メールアドレスを入力 |
| | 3. パスワードを入力 |
| | 4. ログインボタンをクリック |
| 期待結果 | 日報一覧画面に遷移する |
| | ヘッダーにユーザー名が表示される |

#### E2E-LOGIN-002: ログイン失敗

| 項目 | 内容 |
|------|------|
| テストID | E2E-LOGIN-002 |
| シナリオ | パスワード誤り |
| 手順 | 1. /login にアクセス |
| | 2. メールアドレスを入力 |
| | 3. 誤ったパスワードを入力 |
| | 4. ログインボタンをクリック |
| 期待結果 | エラーメッセージが表示される |
| | ログイン画面に留まる |

### 4.2 日報作成シナリオ

#### E2E-REPORT-001: 日報作成（訪問1件）

| 項目 | 内容 |
|------|------|
| テストID | E2E-REPORT-001 |
| シナリオ | 日報新規作成 |
| 前提条件 | 営業ユーザーでログイン済み |
| 手順 | 1. 日報一覧で「新規作成」をクリック |
| | 2. 日付を選択 |
| | 3. 顧客を選択 |
| | 4. 訪問内容を入力 |
| | 5. Problemを入力 |
| | 6. Planを入力 |
| | 7. 「保存」をクリック |
| 期待結果 | 日報詳細画面に遷移する |
| | 入力内容が正しく表示される |

#### E2E-REPORT-002: 日報作成（訪問複数件）

| 項目 | 内容 |
|------|------|
| テストID | E2E-REPORT-002 |
| シナリオ | 複数訪問記録の追加 |
| 手順 | 1. 日報作成画面を開く |
| | 2. 1件目の訪問を入力 |
| | 3. 「追加」ボタンをクリック |
| | 4. 2件目の訪問を入力 |
| | 5. 「保存」をクリック |
| 期待結果 | 2件の訪問記録が保存される |

#### E2E-REPORT-003: 日報作成（訪問削除）

| 項目 | 内容 |
|------|------|
| テストID | E2E-REPORT-003 |
| シナリオ | 訪問記録の削除 |
| 手順 | 1. 訪問記録を2件追加 |
| | 2. 1件目の「×」をクリック |
| | 3. 「保存」をクリック |
| 期待結果 | 1件のみ保存される |

#### E2E-REPORT-004: 日報編集

| 項目 | 内容 |
|------|------|
| テストID | E2E-REPORT-004 |
| シナリオ | 既存日報の編集 |
| 前提条件 | 本人の日報が存在 |
| 手順 | 1. 日報詳細画面で「編集」をクリック |
| | 2. 訪問内容を修正 |
| | 3. 「保存」をクリック |
| 期待結果 | 修正内容が反映される |

### 4.3 コメントシナリオ

#### E2E-COMMENT-001: コメント投稿

| 項目 | 内容 |
|------|------|
| テストID | E2E-COMMENT-001 |
| シナリオ | 上長がコメント投稿 |
| 前提条件 | 上長ユーザーでログイン済み |
| 手順 | 1. 日報詳細画面を開く |
| | 2. Problemのコメント欄に入力 |
| | 3. 「送信」をクリック |
| 期待結果 | コメントが表示される |
| | 投稿者名と日時が表示される |

#### E2E-COMMENT-002: コメント投稿（営業は不可）

| 項目 | 内容 |
|------|------|
| テストID | E2E-COMMENT-002 |
| シナリオ | 営業ユーザーはコメント不可 |
| 前提条件 | 営業ユーザーでログイン済み |
| 期待結果 | コメント入力欄が表示されない |

### 4.4 顧客管理シナリオ

#### E2E-CUSTOMER-001: 顧客登録

| 項目 | 内容 |
|------|------|
| テストID | E2E-CUSTOMER-001 |
| シナリオ | 新規顧客登録 |
| 前提条件 | 上長ユーザーでログイン済み |
| 手順 | 1. 顧客一覧で「新規登録」をクリック |
| | 2. 顧客名を入力 |
| | 3. 住所を入力 |
| | 4. 「保存」をクリック |
| 期待結果 | 顧客一覧に新規顧客が表示される |

#### E2E-CUSTOMER-002: 顧客検索

| 項目 | 内容 |
|------|------|
| テストID | E2E-CUSTOMER-002 |
| シナリオ | 顧客名で検索 |
| 手順 | 1. 検索欄に「ABC」と入力 |
| | 2. 「検索」をクリック |
| 期待結果 | "ABC"を含む顧客のみ表示される |

### 4.5 ユーザー管理シナリオ

#### E2E-USER-001: ユーザー登録

| 項目 | 内容 |
|------|------|
| テストID | E2E-USER-001 |
| シナリオ | 新規ユーザー登録 |
| 前提条件 | 上長ユーザーでログイン済み |
| 手順 | 1. ユーザー一覧で「新規登録」をクリック |
| | 2. 各項目を入力 |
| | 3. 「保存」をクリック |
| 期待結果 | 新規ユーザーが登録される |
| | 登録ユーザーでログイン可能 |

### 4.6 権限シナリオ

#### E2E-AUTH-001: 営業ユーザーの権限制限

| 項目 | 内容 |
|------|------|
| テストID | E2E-AUTH-001 |
| シナリオ | 営業は管理機能にアクセス不可 |
| 前提条件 | 営業ユーザーでログイン済み |
| 確認項目 | ナビに「ユーザー管理」が表示されない |
| | /users に直接アクセスするとリダイレクト |
| | 顧客一覧で「新規登録」が表示されない |

#### E2E-AUTH-002: 未認証アクセス

| 項目 | 内容 |
|------|------|
| テストID | E2E-AUTH-002 |
| シナリオ | 未ログインでアクセス |
| 手順 | /reports に直接アクセス |
| 期待結果 | /login にリダイレクトされる |

---

## 5. テストデータ

### 5.1 ユーザーデータ

| ID | 名前 | メール | パスワード | 役職 |
|----|------|--------|------------|------|
| user_001 | 山田太郎 | yamada@example.com | password123 | SALES |
| user_002 | 佐藤花子 | sato@example.com | password123 | SALES |
| user_003 | 鈴木部長 | suzuki@example.com | password123 | MANAGER |

### 5.2 顧客データ

| ID | 顧客名 | 住所 |
|----|--------|------|
| customer_001 | ABC株式会社 | 東京都渋谷区... |
| customer_002 | XYZ商事 | 大阪府大阪市... |
| customer_003 | DEF工業 | 愛知県名古屋市... |

### 5.3 日報データ

| ID | ユーザー | 日付 | 訪問件数 |
|----|----------|------|----------|
| report_001 | user_001 | 2024-12-15 | 2 |
| report_002 | user_001 | 2024-12-14 | 1 |
| report_003 | user_002 | 2024-12-15 | 3 |

---

## 6. テストカバレッジ目標

| 種別 | 目標 |
|------|------|
| 単体テスト | 80%以上 |
| 結合テスト | 主要API 100% |
| E2Eテスト | 主要シナリオ 100% |

---

## 7. テスト実行コマンド

```bash
# 単体テスト
npm run test:unit

# 結合テスト
npm run test:integration

# E2Eテスト
npm run test:e2e

# 全テスト実行
npm run test

# カバレッジレポート
npm run test:coverage
```
